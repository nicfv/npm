#!/usr/bin/env bash

# Fail if node or npm not found
node -v || exit 1
npm -v || exit 1

# Run tests on ci workflow
npm start || exit 1

# Check for and set npm token if publish flag is set
if [[ "${1}" == 'publish' ]] ; then
    if [[ -z "${NPM_TOKEN}" ]] ; then
        echo 'Missing environment variable NPM_TOKEN'
        exit 1
    else
        npm config set '//registry.npmjs.org/:_authToken' "${NPM_TOKEN}" || exit 1
        npm publish --provenance --workspaces || echo 'One or several packages are already published and were skipped.'
    fi
fi